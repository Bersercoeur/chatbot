{{ extends "chatGPT/Page.html" }}

{{ block title }}
<div class="banner">
    <img src="{% static 'gamer_online.png' %}" alt="Chatbot Logo" class="banner-logo">
    Rex Cinema Chatbot
</div>
{{ endblock }}

{{ block scripts }}
    <script>
        var chatLogData = [];
        var timeBase = Date.now();

        // Initial message from the bot
        document.addEventListener("DOMContentLoaded", function (event) {
            botMessage("Hey there! I'm Alex, your Rex Cinema digital assistant bot. How can I help you?", function() {
                addButtons(["Can you help me find a movie to watch today?"], ["movieSearch"]);
            });
        });

        // Function to log chat
        function logChat(sender, chatText) {
            let timestamp = (Date.now() - timeBase) / 1000;
            var currentMsg = {
                sender: sender,
                text: chatText,
                timestamp: timestamp
            };
            chatLogData.push(currentMsg);
            document.getElementById('id_chatLog').value = JSON.stringify(chatLogData);
        }

        // Function to show the typing indicator
        function showTyping() {
            let typingIndicator = document.createElement('div');
            typingIndicator.classList.add('typing-indicator');
            typingIndicator.innerHTML = `<span class="dot"></span><span class="dot"></span><span class="dot"></span>`;
            chat_messages.appendChild(typingIndicator);
            chat_messages.scrollIntoView({ behavior: 'smooth', block: 'end', inline: 'start' });
        }

        // Function to remove the typing indicator
        function hideTyping() {
            let typingIndicator = document.querySelector('.typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Function to send bot messages with delay
        function botMessage(text, callback) {
            showTyping();
            setTimeout(function() {
                hideTyping();
                let row = `
                    <div class="bot-name">Alex</div>
                    <div class="msg">
                        <img src="{% static 'gamer.png' %}" alt="Chatbot Logo" class="chatbot-logo">
                        <div class="msg-content botText">${text}</div>
                    </div><br>`;
                chat_messages.insertAdjacentHTML('beforeend', row);
                chat_messages.scrollIntoView({ behavior: 'smooth', block: 'end', inline: 'start' });
                logChat('Bot', text);
                
                if (callback) {
                    callback(); // Call the function to add buttons after the message is displayed
                }
            }, 1000); // Simulate typing delay
        }

        // Function to handle user's choice
        function userMessage(option) {
            let row = `<div class="msg" style="justify-content: flex-end;">
                            <div class="msg-content selfText">${option}</div>
                       </div>`;
            chat_messages.insertAdjacentHTML('beforeend', row);
            chat_messages.scrollIntoView({ behavior: 'smooth', block: 'end', inline: 'start' });
            logChat('Participant', option);
        }

        // Function to add buttons for user's options
        function addButtons(options, actions) {
            document.getElementById('buttonContainer').innerHTML = '';  // Clear previous buttons
            options.forEach((option, index) => {
                let button = document.createElement('button');
                button.type = 'button';
                button.textContent = option;
                button.classList.add('chatButton');
                button.onclick = function() { handleUserChoice(actions[index], option); };
                document.getElementById('buttonContainer').appendChild(button);
            });

            // Show the placeholder text after buttons
            document.getElementById('chooseOptionContainer').style.display = 'block';
        }

        // Function to handle the chat flow based on user's choices
        function handleUserChoice(action, userText) {
            userMessage(userText);
            switch(action) {
                case 'movieSearch':
                    botMessage("Yes, of course. Do you feel like watching a romance, action, horror, or comedy movie?", function() {
                        addButtons([
                            "I feel like watching something with action today. What movie can I watch?",
                            "I feel like watching something romantic today. What movie can I watch?",
                            "I feel like watching something scary today. What movie can I watch?",
                            "I feel like watching something funny today. What movie can I watch?"
                        ], ['action', 'romance', 'horror', 'comedy']);
                    });
                    break;
                case 'action':
                    botMessage("Good choice. There’s the latest Deadpool movie with Wolverine, starring Ryan Reynolds and Hugh Jackman. Deadpool unites with his would-be pal, Wolverine, to complete the mission and save his world from an existential threat. How does that sound?", function() {
                        addButtons(["Perfect! When can I watch it?"], ['showtimes']);
                    });
                    break;
                case 'romance':
                    botMessage("Great choice. There’s \"Anyone But You,\" starring Sydney Sweeney and Glen Powell. Despite having an amazing first date, Bea and Ben's initial attraction quickly turns sour. When they unexpectedly find themselves at a destination wedding in Australia, the pair pretend to be the perfect couple to keep up appearances.", function() {
                        addButtons(["Perfect! When can I watch it?"], ['showtimes']);
                    });
                    break;
                case 'horror':
                    botMessage("If you’re up for a scare, how about \"Alien: Romulus\"? Directed by Fede Alvarez, it stars Cailee Spaeny and David Jonsson. Space colonizers come face to face with the most terrifying life-form in the universe while scavenging the deep ends of a derelict space station.", function() {
                        addButtons(["Perfect! When can I watch it?"], ['showtimes']);
                    });
                    break;
                case 'comedy':
                    botMessage("How about a laugh? There’s the latest Deadpool movie with Wolverine, starring Ryan Reynolds and Hugh Jackman. It’s packed with action and humor!", function() {
                        addButtons(["Perfect! When can I watch it?"], ['showtimes']);
                    });
                    break;
                case 'showtimes':
                    botMessage("You can watch the movie at 1:45 PM, 4 PM, or 9 PM. Which showtime fits you best?", function() {
                        addButtons([
                            "1:45 PM. What is the ticket price?",
                            "4 PM. What is the ticket price?",
                            "9 PM. What is the ticket price?"
                        ], ['price', 'price', 'price']);
                    });
                    break;
                case 'price':
                    botMessage("The ticket will be only 8 Euros. Would you also like to add a 8 Euros menu to your ticket with a snack (popcorn, M&Ms or chips) and a drink?", function() {
                        addButtons(["Yes, I will add the menu.", "No, I don’t want it."], ['yesMenu', 'noMenu']);
                    });
                    break;
                case 'yesMenu':
                    botMessage("Thanks! The booking is done. The booking code is HIUZ65. Bring it with you to the cinema when collecting your tickets. Have a nice day!", function() {
                        removeButtons();
                        showNextButton();
                    });
                    break;
                case 'noMenu':
                    botMessage("No problem! The booking is done. Your booking code is HIUZ65. Bring it with you to the cinema when collecting your tickets. Have a nice day!", function() {
                        removeButtons();
                        showNextButton();
                    });
                    break;
            }
        }

        // Function to remove buttons at the end of the dialog
        function removeButtons() {
            document.getElementById('buttonContainer').innerHTML = '';
            document.getElementById('chooseOptionContainer').style.display = 'none';
        }

        // Function to show the "Next Page" button
        function showNextButton() {
            document.getElementById('nextPageButton').style.display = 'block';
        }

        var chat_messages = document.getElementById('chat_messages');
    </script>
{{ endblock }}

{{ block content }}

    <!-- div displaying chat messages -->
    <div class="textBox">
        <div id="chat_messages">
        </div>
    </div>

    <!-- Container for buttons and Placeholder text - Outside of Chat Container -->
    <div id="buttonContainer" class="inputBox">
    </div>
    
    <div id="chooseOptionContainer" class="choose-option-container" style="display: none;">
        <p class="choose-option">Choose an option above...</p>
    </div>

    <!-- Next Page Button -->
    <button id="nextPageButton" class="btn btn-primary btn-large" style="display:none;" onclick="liveSend({});">
        Next Page
    </button>

    <!-- hidden input to save chat log -->
    <input type='hidden' name='chatLog' value='' id='id_chatLog'/>
        
{{ endblock }}
